<%- include('partials/header', { pageTitle: '我的持仓 | Dashboard' }) %>
<%- include('partials/sidebar', { activePage: 'orders' }) %>

<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
  <div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">我的持仓</h1>
  </div>

  <!-- 添加新股票 -->
  <div class="card mb-4">
    <div class="card-header">添加新股票</div>
    <div class="card-body">
      <form id="addForm" class="row g-3">
        <div class="col-md-3">
          <input type="text" name="stockName" class="form-control" placeholder="股票名称" required>
        </div>
        <div class="col-md-3">
          <input type="text" name="ticker" class="form-control" placeholder="股票代码" required>
        </div>
        <div class="col-md-3">
          <input type="number" step="0.01" name="buyPrice" class="form-control" placeholder="买入价格" required>
        </div>
        <div class="col-md-3">
          <input type="number" name="quantity" class="form-control" placeholder="数量" required>
        </div>
        <div class="col-md-12 d-grid mt-2">
          <button type="submit" class="btn btn-success">添加</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 当前持仓表格 -->
  <h2>数据列表</h2>
  <div class="table-responsive">
    <table class="table table-hover table-bordered align-middle">
      <thead class="table-secondary">
        <tr>
          <th>ID</th>
          <th>名称</th>
          <th>代码</th>
          <th>买入价格</th>
          <th>数量</th>
          <th>当前价格</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <% tableData.forEach(item => { %>
        <tr>
          <td><%= item.id %></td>
          <td><%= item.stockName %></td>
          <td><%= item.ticker %></td>
          <td><%= (item.TbuyPrice/item.quantity).toFixed(2) %></td>
          <td><%= item.quantity %></td>
          <td><%= item.currentPrice %></td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1"
                    data-bs-toggle="modal"
                    data-bs-target="#editModal"
                    onclick='populateModal(<%- JSON.stringify(item) %>)'>编辑</button>
            <button class="btn btn-sm btn-outline-danger"
                    onclick="handleDelete(<%= item.id %>)">删除</button>
          </td>
        </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</main>

</div>
<%- include('partials/footer') %>

<!-- 编辑模态框 -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editForm">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title">编辑股票信息</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-3">
          <div class="mb-3">
            <label for="edit-stockName" class="form-label">股票名称</label>
            <input type="text" name="stockName" id="edit-stockName" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="edit-ticker" class="form-label">股票代码</label>
            <input type="text" name="ticker" id="edit-ticker" class="form-control" required>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">买入价格</label>
              <input type="number" step="0.01" name="buyPrice" id="edit-buyPrice" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">数量</label>
              <input type="number" name="quantity" id="edit-quantity" class="form-control" required>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">保存</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- JavaScript 部分 -->
<script>
  function populateModal(data) {
    document.getElementById('editForm').action = `/stocks/update/${data.id}`;
    document.getElementById('edit-stockName').value = data.stockName;
    document.getElementById('edit-ticker').value = data.ticker;
    document.getElementById('edit-buyPrice').value = (data.TbuyPrice/data.quantity).toFixed(2);
    //  document.getElementById('edit-buyPrice').value = data.TbuyPrice;
    document.getElementById('edit-quantity').value = data.quantity;
  }

  document.getElementById("addForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    const form = e.target;
    const data = {
      stockName: form.stockName.value,
      ticker: form.ticker.value,
      buyPrice: parseFloat(form.buyPrice.value),
      quantity: parseInt(form.quantity.value)
    };

    const response = await fetch("/stocks/add", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    if (response.ok) {
      location.reload();
    } else {
      alert("添加失败，请检查输入");
    }
  });

  document.getElementById("editForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    const form = e.target;
    const action = form.action;
    const data = {
      stockName: form.stockName.value,
      ticker: form.ticker.value,
      buyPrice: parseFloat(form.buyPrice.value),
      quantity: parseInt(form.quantity.value)
    };

    const response = await fetch(action, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    if (response.ok) {
      location.reload();
    } else {
      alert("更新失败，请重试");
    }
  });

  async function handleDelete(id) {
    if (!confirm("确定要删除这只股票吗？")) return;

    const response = await fetch(`/stocks/delete/${id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" }
    });

    if (response.ok) {
      location.reload();
    } else {
      alert("删除失败，请重试");
    }
  }
</script>
