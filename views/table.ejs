<%- include('partials/header', { pageTitle: '我的持仓 | Dashboard' }) %>
<%- include('partials/sidebar', { activePage: 'orders' }) %>

<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
  <div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">我的持仓</h1>
  </div>

  <!-- 添加新股票 -->
  <div class="card mb-4">
    <div class="card-header">添加新股票</div>
    <div class="card-body">
      <form id="addForm" class="row g-3">
        <div class="col-md-3">
          <input type="text" name="stockName" class="form-control" placeholder="股票名称" required>
        </div>
        <div class="col-md-3">
          <input type="text" name="ticker" class="form-control" placeholder="股票代码" required>
        </div>
        <div class="col-md-3">
          <input type="number" step="0.01" name="buyPrice" class="form-control" placeholder="买入价格" required>
        </div>
        <div class="col-md-3">
          <input type="number" name="quantity" class="form-control" placeholder="数量" required>
        </div>
        <div class="col-md-12 d-grid mt-2">
          <button type="submit" class="btn btn-success">添加</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 当前持仓表格 -->
  <h2>数据列表</h2>
  <div class="table-responsive">
    <table class="table table-hover table-bordered align-middle">
      <thead class="table-secondary">
        <tr>
          <th>ID</th>
          <th>名称</th>
          <th>代码</th>
          <th>买入价格</th>
          <th>数量</th>
          <th>当前价格</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <% tableData.forEach(item => { %>
        <tr style="cursor:pointer;" onclick="showDetails(<%= item.id %>)">
          <td><%= item.id %></td>
          <td><%= item.stockName %></td>
          <td><%= item.ticker %></td>
          <td><%= (item.TbuyPrice / item.quantity).toFixed(2) %></td>
          <td><%= item.quantity %></td>
          <td><%= item.currentPrice %></td>
          <td>
            <button class="btn btn-sm btn-outline-success me-1"
                    onclick='event.stopPropagation(); openQuantityModal("increase", <%- JSON.stringify(item) %>)'>
              增加
            </button>
            <button class="btn btn-sm btn-outline-warning me-1"
                    onclick='event.stopPropagation(); openQuantityModal("decrease", <%- JSON.stringify(item) %>)'>
              减少
            </button>
            <button class="btn btn-sm btn-outline-danger"
                    onclick='event.stopPropagation(); handleDelete(<%= item.id %>)'>
              删除
            </button>
          </td>
        </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</main>

<!-- 修改数量模态框 -->
<div class="modal fade" id="quantityModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="quantityForm">
      <div class="modal-content">
        <div class="modal-header bg-secondary text-white">
          <h5 class="modal-title" id="quantityModalTitle">修改数量</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="id" id="quantity-id">
          <div class="mb-3">
            <label id="quantityLabel" class="form-label">更改数量</label>
            <input type="number" name="amount" id="quantity-amount" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">提交</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- 详情模态框 -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title" id="detailModalTitle">股票详情</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <canvas id="detailChart" height="100"></canvas>
        <hr>
        <div id="detailInfo" class="mt-3"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
      </div>
    </div>
  </div>
</div>
<%- include('partials/footer') %>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  let quantityAction = null;
  let detailChart = null;

  // 打开增加/减少数量模态框
  function openQuantityModal(action, data) {
    quantityAction = action;
    document.getElementById("quantity-id").value = data.id;
    document.getElementById("quantity-amount").value = "";
    const title = action === "increase" ? "增加数量" : "减少数量";
    const label  = action === "increase"
      ? "请输入要增加的数量："
      : "请输入要减少的数量：";
    document.getElementById("quantityModalTitle").textContent = title;
    document.getElementById("quantityLabel").textContent = label;
    new bootstrap.Modal(document.getElementById("quantityModal")).show();
  }

  // 提交数量变更
  document.getElementById("quantityForm").addEventListener("submit", async e => {
    e.preventDefault();
    const id     = document.getElementById("quantity-id").value;
    const amount = parseInt(document.getElementById("quantity-amount").value, 10);
    
    const res = await fetch(`/stocks/${quantityAction}/${id}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ amount })
    });
    if (res.ok) location.reload();
    else alert('操作失败，请稍后重试');
  });

  // 删除持仓
  async function handleDelete(id) {
    if (!confirm('确认要删除此持仓吗？')) return;
    const res = await fetch(`/stocks/delete/${id}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    if (res.ok) location.reload();
    else alert('删除失败，请稍后重试');
  }

  // 添加新股票
  document.getElementById("addForm").addEventListener("submit", async e => {
    e.preventDefault();
    const form = e.target;
    const payload = {
      stockName: form.stockName.value,
      ticker:    form.ticker.value,
      buyPrice:  parseFloat(form.buyPrice.value * form.quantity.value),
      quantity:  parseInt(form.quantity.value, 10)
    };
    const res = await fetch('/stocks/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (res.ok) location.reload();
    else alert('添加失败，请稍后重试');
  });

  // 显示详情：拉取最近7天收盘价并绘制图表
  async function showDetails(id) {
    const res  = await fetch(`/stocks/details/${id}`);
    if (!res.ok) return alert('获取详情失败');
    const data = await res.json();

    // 填充标题
    document.getElementById("detailModalTitle")
      .textContent = `${data.stockName} (${data.ticker}) 详情`;

    // 绘制折线图
    const ctx = document.getElementById('detailChart').getContext('2d');
    if (detailChart) detailChart.destroy();
    detailChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.history.map(d => d[1]),
        datasets: [{
          label: '收盘价',
          data:  data.history.map(d => d[2]),
          borderColor: 'rgb(75, 192, 192)',
          tension: 0.1
        }]
      },
      options: {
        scales: {
          x: { title: { display: true, text: '日期' } },
          y: { title: { display: true, text: '价格 (元)' } }
        }
      }
    });

    // 填充其他信息
    document.getElementById('detailInfo').innerHTML = `
      <p>当前价格：${data.currentPrice}</p>
      <p>买入价格：${data.buyPrice}</p>
      <p>持仓数量：${data.quantity}</p>
      <p>成本总额：${(data.buyPrice * data.quantity).toFixed(2)}</p>
      <p>浮动盈亏：${((data.currentPrice - data.buyPrice) * data.quantity).toFixed(2)}</p>
    `;

    // 显示模态框
    new bootstrap.Modal(document.getElementById('detailModal')).show();
  }
</script>
