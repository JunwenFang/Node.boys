<!-- 继承公共头部 -->
<%- include('partials/header', { pageTitle: '曲线图 | Dashboard' }) %>

  <!-- 继承侧边栏（标记当前活跃页） -->
  <%- include('partials/sidebar', { activePage: 'dashboard' }) %>

    <!-- 主内容区：曲线图 -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div
        class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">账户数据概览</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
          <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary">Share</button>
            <button type="button" class="btn btn-sm btn-outline-secondary">Export</button>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle">
            <span data-feather="calendar"></span>
            <%= dateRange || 'This week' %> <!-- 动态日期范围 -->
          </button>
        </div>
      </div>

      <div class="row align-items-stretch min-vh-100"> <!-- 使用Bootstrap的栅格系统 -->
        <!-- 左侧列 -->
        <div class="col-md-6 d-flex flex-column h-100">
          <!-- 用户信息框 -->
          <div class="card mb-4 flex-grow-1">
            <div class="card-header">
              <h5>账户信息</h5>
            </div>
            <div class="card-body">
              <div id="userInfo">
                <p><strong>用户名:</strong>
                  <%= user?.name || '未登录' %>
                </p>
                <p><strong>账户类型:</strong>
                  <%= user?.accountType || '普通账户' %>
                </p>
                <p>
                  <strong>可用现金流:</strong>
                  $<span id="cash-value">
                    <%= (user?.cash || 0).toLocaleString() %>
                  </span>
                  <button id="cash-increase"
                    class="btn btn-md btn-danger d-inline-flex align-items-center justify-content-center p-0 me-2"
                    style="width:2.2rem;height:2.2rem;border-radius:0.5rem;">
                    <i class="bi-plus" style="font-size:1.5rem;font-weight:bold;"></i>
                  </button>
                  <button id="cash-decrease"
                    class="btn btn-md btn-success d-inline-flex align-items-center justify-content-center p-0"
                    style="width:2.2rem;height:2.2rem;border-radius:0.5rem;">
                    <i class="bi-dash" style="font-size:1.5rem;font-weight:bold;"></i>
                  </button>
                </p>
                <p>
                  <strong>证券价值:</strong>
                  $<span id="investments-value">
                    <%= (user?.investments || 0).toLocaleString() %>
                  </span>
                </p>
                <p>
                  <strong>总资产价值:</strong>
                  $<span id="total-value">
                    <%= ((user?.cash || 0) + (user?.investments || 0)).toLocaleString() %>
                  </span>
                </p>

              </div>
            </div>
          </div>

          <!-- 饼图容器 -->
          <div class="card mb-4 flex-grow-1">
            <div class="card-header">
              <h5>资产分布</h5>
            </div>
            <div class="card-body">
              <canvas id="pieChart" width="300" height="200" data-cash="<%= user?.cash || 60 %>"
                data-investments="<%= user?.investments || 40 %>">
              </canvas>
            </div>
          </div>
        </div>

        <!-- 右侧列 -->
        <div class="col-md-6 d-flex flex-column" style="gap: 1rem;">
          <!-- 曲线图容器 -->
          <div class="card" style="flex: 1;">
            <div class="card-header">
              <h5>历史趋势</h5>
            </div>
            <div class="card-body">
              <canvas id="myChart" width="400" height="200"></canvas>
            </div>
          </div>

          <!-- 投资比例柱状图模块 -->
        <div class="card" style="flex: 1;">
           <div class="card-header">
            <h5>投资比例（现金 vs 权益）</h5>
          </div>
          <div class="card-body">
            <canvas id="barChart" width="300" height="200"></canvas>
          </div>
          
        </div>
      </div>
    </main>

    <script>
      // 图表数据通过HTML元素属性传递
      window.chartLabels = <%- JSON.stringify(lineData.labels || []) %>;
      window.chartValues = <%- JSON.stringify(lineData.values || []) %>;
      window.pieLabels = <%- JSON.stringify(pieData.labels || []) %>;
      window.pieValues = <%- JSON.stringify(pieData.values || []) %>;
      // 新增：柱状图数据
      window.barLabels = <%- JSON.stringify(barData.labels || []) %>;
      window.barCash = <%- JSON.stringify(barData.cash || []) %>;
      window.barInvestments = <%- JSON.stringify(barData.investments || []) %>;
      // 图表数据已通过HTML5 data属性传递
    </script>

    </div> <!-- 关闭sidebar.ejs中的.container-fluid -->

    <%- include('partials/footer') %>